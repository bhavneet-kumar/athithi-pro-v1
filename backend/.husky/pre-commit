#!/usr/bin/env sh

echo "ğŸ” Running pre-commit checks..."

# Run lint-staged to auto-fix ESLint issues and format code on staged files
echo "ğŸ”§ Auto-fixing ESLint issues and formatting code on staged files..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo "âŒ Pre-commit checks failed. There are linting issues that couldn't be auto-fixed."
  echo "Please review and fix the remaining issues in your staged files before committing."
  exit 1
fi

# Run lint check only on staged files
echo "ğŸ” Running final lint check on staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'backend/.*\.(js|jsx|ts|tsx)$' | sed 's/backend\///' | tr '\n' ' ')

if [ -n "$STAGED_FILES" ]; then
  npx eslint $STAGED_FILES
  
  if [ $? -eq 0 ]; then
    echo "âœ… All pre-commit checks passed successfully!"
  else
    echo "âŒ There are still linting issues that need manual attention in your staged files."
    echo "Please fix the remaining linting errors and try committing again."
    exit 1
  fi
else
  echo "âœ… No JavaScript/TypeScript files to lint."
fi
